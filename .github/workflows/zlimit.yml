name: GCFT z-limit (low-z only)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  reproduce:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ§± Init Git LFS
        run: |
          git lfs install
          git lfs pull || true

      - name: ðŸ§¬ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ§° Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gfortran libopenblas-dev liblapack-dev

      - name: ðŸ“¦ Install Python dependencies
        if: hashFiles('requirements.txt') != ''
        run: pip install -r requirements.txt

      - name: ðŸ§² Fetch CLASS code
        run: |
          rm -rf class_public
          git clone --depth 1 https://github.com/lesgourg/class_public.git class_public

      - name: ðŸ“Ž Copy GCFT files into CLASS dir
        run: |
          cp gcft_zlimit_lowz.ini gcft_class_background.dat class_public/

      - name: ðŸ”¨ Build & run CLASS
        working-directory: class_public
        run: |
          make -j"$(nproc)"
          # Force root prefix without "output/"
          sed -i 's/^root *=.*/root = gcft00_/g' gcft_zlimit_lowz.ini
          echo "ðŸ“ˆ Running CLASS..."
          ./class gcft_zlimit_lowz.ini | tee ../class_run.log
          STATUS=${PIPESTATUS[0]}
          if [ "$STATUS" -ne 0 ]; then
            echo "âŒ CLASS failed with exit $STATUS"
            exit $STATUS
          fi
          cp gcft00_*.dat "$GITHUB_WORKSPACE/" || true

      - name: ðŸ“‚ List output files
        run: ls -lh gcft00_*.dat || true

      - name: ðŸ“œ Show CLASS stdout
        run: cat class_run.log || true

      - name: âœï¸ Write verify script
        run: |
          cat > verify.py <<'PY'
          import sys, re, numpy as np, pathlib as P

          pairs = [
            ("gcft00_pk.dat","gcft00_pk.dat"),
            ("gcft00_cl.dat","gcft00_cl.dat"),
            ("gcft00_background.dat","gcft00_background.dat"),
            ("gcft00_thermodynamics.dat","gcft00_thermodynamics.dat"),
          ]

          num = re.compile(r'^[+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][+-]?\d+)?$')
          def load(path):
              rows=[]
              for ln in open(path,'r',errors='ignore'):
                  s=ln.strip()
                  if not s or s.startswith('#'): continue
                  toks=[t for t in re.split(r'\s+', s) if num.match(t)]
                  if not toks: continue
                  rows.append([float(t) for t in toks])
              return np.array(rows,float)

          def max_rel(a,b):
              return float(np.nanmax(np.abs(a-b)/np.maximum(np.abs(b),1e-12)))

          ok=True
          tol=5e-6
          for new, ref in pairs:
              pn, pr = P.Path(new), P.Path(ref)
              if not pn.exists():
                  print(f"[FAIL] missing {new}"); ok=False; continue
              if not pr.exists():
                  print(f"[WARN] no baseline {ref}"); continue
              A,B = load(pn), load(pr)
              if A.shape != B.shape:
                  print(f"[FAIL] shape {A.shape}!={B.shape} for {new}"); ok=False
              else:
                  diff=max_rel(A,B)
                  print(f"[{'OK' if diff<=tol else 'FAIL'}] {new} diff={diff:.3e}")
                  if diff>tol: ok=False
          sys.exit(0 if ok else 1)
          PY

      - name: âœ… Verify outputs vs baselines
        run: python verify.py

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gcft-outputs
          path: gcft00_*.dat
