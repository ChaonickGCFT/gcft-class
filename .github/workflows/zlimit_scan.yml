name: GCFT z-limit scan

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/zlimit_scan.yml"
      - "**/*.ini"
      - "gcft_class_background.dat"
      - "verify_z.py"

jobs:
  zlimit:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4

      - name: 🔎 Locate z-limit INI
        id: findini
        shell: bash
        run: |
          set -e
          echo "Searching for candidate *.ini files…"
          git ls-files '*.ini' || true

          # Try common names first, then fuzzy match
          CANDIDATE=""
          for p in \
            "gcft_redshift_lim.ini" \
            "gcft_zlimit.ini" \
            "zlimit.ini" \
            "$(git ls-files '*.ini' | grep -Ei 'z.?limit|redshift.*lim' | head -n1)"; do
            if [ -n "$p" ] && [ -f "$p" ]; then
              CANDIDATE="$p"
              break
            fi
          done

          if [ -z "$CANDIDATE" ]; then
            echo "::error::No z-limit .ini found. Put it anywhere in the repo (e.g. analysis/z_limit/)."
            echo "Looked for names like: gcft_redshift_lim.ini, gcft_zlimit.ini, zlimit.ini, *z*limit*.ini"
            exit 1
          fi

          echo "Using INI: $CANDIDATE"
          echo "ini=$CANDIDATE" >> $GITHUB_OUTPUT

      - name: 🧾 Ensure background file exists
        id: bg
        shell: bash
        run: |
          set -e
          if [ -f "gcft_class_background.dat" ]; then
            echo "Found gcft_class_background.dat in repo root."
          else
            echo "::error::Missing gcft_class_background.dat in repo root."
            echo "If you keep it elsewhere, either move it here or update your .ini to disable use_tabulated_background."
            exit 1
          fi

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 🛠️ Install system deps
        run: sudo apt-get update && sudo apt-get install -y build-essential gfortran

      - name: 🔄 Fetch CLASS
        run: git clone --depth 1 https://github.com/lesgourg/class_public.git class_public

      - name: ⚙️ Copy config & background
        shell: bash
        run: |
          set -e
          cp "${{ steps.findini.outputs.ini }}" class_public/gcft_zlimit.ini
          cp gcft_class_background.dat class_public/gcft_class_background.dat

      - name: 🚀 Build & run CLASS
        working-directory: class_public
        shell: bash
        run: |
          set -e
          make -j"$(nproc)"
          echo "Running CLASS with gcft_zlimit.ini"
          ./class gcft_zlimit.ini
          mkdir -p "$GITHUB_WORKSPACE/output"
          for f in output/*.dat; do
            b=$(basename "$f")
            # rename prefix to gcft_zlimit_*
            cp "$f" "$GITHUB_WORKSPACE/output/${b/gcft_zlimit/gcft_zlimit}"
          done

      - name: 📂 List outputs
        run: ls -lh output || true

      - name: 🧪 Verify (optional)
        if: hashFiles('verify_z.py') != ''
        run: |
          python -V
          python verify_z.py

      - name: 📤 Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gcft-zlimit-outputs
          path: output/

