name: GCFT build & verify

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ§Š Init Git LFS
        run: |
          git lfs install
          git lfs pull || true

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ› ï¸ Install system deps
        run: sudo apt-get update && sudo apt-get install -y build-essential gfortran

      - name: ðŸ“¦ Install Python deps (if any)
        if: hashFiles('requirements.txt') != ''
        run: pip install -r requirements.txt

      - name: ðŸ”„ Fetch CLASS
        run: git clone --depth 1 https://github.com/lesgourg/class_public.git class_public

      - name: âš™ï¸ Copy config and baseline
        run: |
          cp gcft.ini class_public/gcft.ini
          cp gcft_class_background.dat class_public/gcft00_background.dat
          mkdir -p output

      - name: ðŸš€ Build & run CLASS
        working-directory: class_public
        run: |
          make -j"$(nproc)"
          ./class gcft.ini
          mkdir -p "$GITHUB_WORKSPACE/output"
          for file in output/*.dat; do
            name=$(basename "$file")
            cp "$file" "$GITHUB_WORKSPACE/output/${name/gcft00/gcft01}"
          done

      - name: ðŸ“‚ List outputs
        run: ls -lh output || true

      - name: ðŸ§ª Write verify script
        run: |
          cat > verify.py <<'PY'
import sys, re, numpy as np, pathlib as P

pairs = [
  ("output/gcft01_pk.dat", "gcft00_pk.dat"),
  ("output/gcft01_cl.dat", "gcft00_cl.dat"),
  ("output/gcft01_background.dat", "gcft00_background.dat"),
  ("output/gcft01_thermodynamics.dat", "gcft00_thermodynamics.dat"),
]

def load(path):
    num = re.compile(r'^[+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][+-]?\d+)?$')
    rows = []
    for ln in open(path, 'r', errors='ignore'):
        s = ln.strip()
        if not s or s.startswith('#'):
            continue
        toks = [t for t in re.split(r'\s+', s) if num.match(t)]
        if toks:
            rows.append([float(t) for t in toks])
    return np.array(rows, float)

def max_rel(a, b):
    return float(np.nanmax(np.abs(a - b) / np.maximum(np.abs(b), 1e-12)))

ok = True
tol = 5e-6

for new, ref in pairs:
    pn, pr = P.Path(new), P.Path(ref)
    if not pn.exists():
        print(f"[FAIL] missing {new}"); ok = False; continue
    if not pr.exists():
        print(f"[WARN] no baseline {ref} (skipping)"); continue

    A, B = load(pn), load(pr)

    if new.endswith("_pk.dat"):
        kA, PA = A[:,0], A[:,1]
        kB, PB = B[:,0], B[:,1]
        kmin, kmax = max(kA.min(), kB.min()), min(kA.max(), kB.max())
        m = (kB >= kmin) & (kB <= kmax)
        if not np.any(m):
            print(f"[FAIL] no overlapping k-range for {new}"); ok = False; continue
        PAi = np.interp(kB[m], kA, PA)
        diff = max_rel(PAi, PB[m])
    else:
        if A.shape != B.shape:
            print(f"[FAIL] shape {A.shape} != {B.shape} for {new}"); ok = False; continue
        diff = max_rel(A, B)

    print(f"[{'OK' if diff <= tol else 'FAIL'}] {new} max rel diff={diff:.3e}")
    if diff > tol: ok = False

sys.exit(0 if ok else 1)
PY

      - name: âœ… Run verification
        run: python verify.py

      - name: ðŸ“¤ Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gcft01-outputs
          path: output/gcft01_*.dat
