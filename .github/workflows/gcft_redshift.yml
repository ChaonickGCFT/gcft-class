name: GCFT high-z power spectrum scan

on:
  workflow_dispatch:
  push:
    paths:
      - gcft_redshift_lim.ini
      - verify_z.py
      - .github/workflows/gcft_redshift.yml

jobs:
  redshift-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      OMP_NUM_THREADS: 1

    steps:
      - name: 📥 Checkout this repo
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 📦 Python deps (numpy for verifier)
        run: python -m pip install --upgrade pip numpy

      - name: 🛠️ System deps
        run: sudo apt-get update && sudo apt-get install -y build-essential gfortran

      - name: ⚙️ Build GCFT-CLASS
        run: make -j"$(nproc)"

      - name: 🚀 Run GCFT-CLASS
        run: |
          ./class gcft_redshift_lim.ini
          mkdir -p "$GITHUB_WORKSPACE/output"
          # rename outputs to gcft_zscan_*
          for file in output/*.dat; do
            name=$(basename "$file")
            cp "$file" "$GITHUB_WORKSPACE/output/${name/gcft_redshift_lim/gcft_zscan}"
          done

      # ===== Baselines pulled from your first repo =====
      - name: 📥 Checkout baseline repo (first repo)
        uses: actions/checkout@v4
        with:
          repository: ChaonickGCFT/gcft-class   # adjust if name differs
          ref: main
          path: baseline_repo

      - name: 🧱 Prepare baselines from first repo
        run: |
          mkdir -p baselines
          # Combined baseline if present
          if [ -f baseline_repo/output/gcft00_pk.dat ]; then
            cp baseline_repo/output/gcft00_pk.dat gcft00_pk.dat
          fi
          # Per-z baselines if present
          ls baseline_repo/output/gcft00_pk_z*.dat >/dev/null 2>&1 && \
            cp baseline_repo/output/gcft00_pk_z*.dat baselines/ || true
          # If only combined exists, split into per-z
          if [ ! -e baselines/gcft00_pk_z0000.dat ] && [ -f gcft00_pk.dat ]; then
            python - <<'PY'
import re, pathlib as P, numpy as np
src = P.Path("gcft00_pk.dat")
out = P.Path("baselines"); out.mkdir(exist_ok=True)
z=None; cur=[]
for ln in src.read_text().splitlines():
    s=ln.strip()
    if not s: continue
    if s.startswith('#') and 'z =' in s:
        if z is not None and cur:
            arr=np.array([list(map(float,l.split())) for l in cur if l.strip() and not l.startswith('#')])
            out.joinpath(f"gcft00_pk_z{int(z):04d}.dat").write_text(
                "\n".join(" ".join(map("{:.8e}".format,r)) for r in arr)+"\n")
        z=float(re.findall(r'z\s*=\s*([0-9.]+)',s)[0]); cur=[]
    elif not s.startswith('#'):
        cur.append(s)
if z is not None and cur:
    arr=np.array([list(map(float,l.split())) for l in cur if l.strip() and not l.startswith('#')])
    out.joinpath(f"gcft00_pk_z{int(z):04d}.dat").write_text(
        "\n".join(" ".join(map("{:.8e}".format,r)) for r in arr)+"\n")
print("Baselines written to", out)
PY
          fi
          echo "== Baselines ==" 
          ls -lh baselines || true
          [ -f gcft00_pk.dat ] && ls -lh gcft00_pk.dat || true

      # ===== Verify GCFT outputs =====
      - name: 🧪 Verify z-scan vs baselines
        run: |
          python -V
          python verify_z.py

      - name: 📤 Upload GCFT outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gcft-zscan-outputs
          path: $GITHUB_WORKSPACE/output/

      # ===== Upstream class_public comparison =====
      - name: 📥 Checkout class_public
        uses: actions/checkout@v4
        with:
          repository: lesgourg/class_public
          ref: master
          path: class_public

      - name: ⚙️ Build class_public
        working-directory: class_public
        run: make -j"$(nproc)"

      - name: 🚀 Run class_public
        working-directory: class_public
        run: |
          ./class ../gcft_redshift_lim.ini
          mkdir -p "$GITHUB_WORKSPACE/output_class"
          for file in output/*.dat; do
            name=$(basename "$file")
            cp "$file" "$GITHUB_WORKSPACE/output_class/${name/gcft_redshift_lim/classpub_zscan}"
          done

      - name: 📤 Upload class_public outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: classpub-zscan-outputs
          path: $GITHUB_WORKSPACE/output_class/
